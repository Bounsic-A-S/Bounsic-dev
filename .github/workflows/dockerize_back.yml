name: Dockerize and Deploy Bounsic Back

on:
  push:
    branches:
      - feat/deploy-backend

jobs:
  dockerize_and_deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build Docker image
        run: docker build -t bounsic-back:latest ./bounsic-back

      - name: Verify Docker image
        run: docker inspect bounsic-back:latest || exit 1

      - name: Compress and save image
        run: docker save bounsic-back:latest | gzip > bounsic-back.tar.gz

      - name: Transfer files to Azure VM
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.AZURE_VM_IP }}
          username: ${{ secrets.AZURE_VM_USER }}
          key: ${{ secrets.AZURE_VM_PRIVATE_KEY }}
          port: 22
          source: "bounsic-back.tar.gz"
          target: "/home/${{ secrets.AZURE_VM_USER }}/bounsic/"

      - name: Deploy Docker Container
        run: |
          set -x # Para depurar, muestra los comandos que se ejecutan

          # Divide la variable vars.ENV_BACK en líneas y pasa cada una como -e
          while IFS= read -r line; do
            if [[ -n "$line" ]]; then # Asegurarse de que la línea no esté vacía
              docker run -d \
                --name bounsic-back \
                -e "$line" \
                -p 1801:8000 \
                --restart always \
                bounsic-back:latest
              break # Ejecutamos el run una vez con todas las variables
            fi
          done <<< "${{ vars.ENV_BACK }}"

          set +x # Desactivar la depuración
