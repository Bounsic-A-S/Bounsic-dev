name: Dockerize and Deploy Bounsic Back

on:
  push:
    branches:
      - feat/deploy-backend

jobs:
  dockerize_and_deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Create .env from variable
        run: |
          mkdir -p ./bounsic-back/env
          # Conversión robusta de \n a saltos de línea reales
          echo "${{ vars.ENV_BACK }}" | awk '{gsub(/\\n/, "\n")}1' > ./bounsic-back/env/.env.dev
          
          # Verificación EXTRA-ROBUSTA
          echo "=== Verificación de estructura ==="
          grep -o '^[^=]*' ./bounsic-back/env/.env.dev # Muestra solo nombres de variables
          echo "================================="
          
          # Validación crítica
          if [ $(grep -c '=' ./bounsic-back/env/.env.dev) -lt 8 ]; then
            echo "❌ Error: Archivo .env incompleto o mal formado"
            exit 1
          fi

      - name: Build and verify
        run: |
          docker build -t bounsic-back:latest ./bounsic-back
          docker run --rm -v $(pwd)/bounsic-back/env:/app/env bounsic-back:latest \
            sh -c '[ -f /app/env/.env.dev ] && echo "✔ .env encontrado" || exit 1'

      - name: Deploy to Azure
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.AZURE_VM_IP }}
          username: ${{ secrets.AZURE_VM_USER }}
          key: ${{ secrets.AZURE_VM_PRIVATE_KEY }}
          port: 22
          script: |
            cd /home/${{ secrets.AZURE_VM_USER }}/bounsic
            # Usamos el mismo método infalible en el servidor
            echo "${{ vars.ENV_BACK }}" | awk '{gsub(/\\n/, "\n")}1' > .env.prod
            mkdir -p env
            mv .env.prod env/.env.dev
            chmod 640 env/.env.dev
            
            # Despliegue
            docker load -i bounsic-back.tar.gz
            docker run -d \
              --name bounsic-back \
              -v $(pwd)/env/.env.dev:/app/env/.env.dev:ro \
              -p 1801:8000 \
              --restart unless-stopped \
              bounsic-back:latest